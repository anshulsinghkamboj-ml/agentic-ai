<mxfile host="app.diagrams.net">
  <diagram name="Phase 3 Agent Flow">
    <mxGraphModel dx="1200" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1200" pageHeight="800">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <mxCell id="start" value="START RUN" style="ellipse;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf" vertex="1" parent="1">
          <mxGeometry x="500" y="20" width="160" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="init" value="Initialize RunState&#10;- task&#10;- metrics&#10;- memory" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656" vertex="1" parent="1">
          <mxGeometry x="470" y="110" width="220" height="90" as="geometry"/>
        </mxCell>

        <mxCell id="loop" value="FOR attempt &lt; MAX_STEPS" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6" vertex="1" parent="1">
          <mxGeometry x="470" y="230" width="220" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="plan" value="PLAN&#10;get_plan()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366" vertex="1" parent="1">
          <mxGeometry x="470" y="320" width="220" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="exec" value="EXECUTE PLAN&#10;(tools)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366" vertex="1" parent="1">
          <mxGeometry x="470" y="400" width="220" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="exec_ok" value="Execution OK?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450" vertex="1" parent="1">
          <mxGeometry x="500" y="490" width="160" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="critique" value="CRITIQUE&#10;decision + confidence" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf" vertex="1" parent="1">
          <mxGeometry x="470" y="600" width="220" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="decision" value="Decision?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450" vertex="1" parent="1">
          <mxGeometry x="500" y="700" width="160" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="accept" value="ACCEPT&#10;Write Memory&#10;EXIT" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366" vertex="1" parent="1">
          <mxGeometry x="200" y="820" width="220" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="fail" value="FAIL&#10;Write Memory&#10;EXIT" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450" vertex="1" parent="1">
          <mxGeometry x="760" y="820" width="220" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="replan" value="REPLAN&#10;Quality Gates&#10;- budget&#10;- confidence" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656" vertex="1" parent="1">
          <mxGeometry x="470" y="820" width="220" height="100" as="geometry"/>
        </mxCell>

        <!-- Edges -->
        <mxCell id="e1" style="edgeStyle=orthogonalEdgeStyle;endArrow=block" edge="1" parent="1" source="start" target="init">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e2" style="edgeStyle=orthogonalEdgeStyle;endArrow=block" edge="1" parent="1" source
